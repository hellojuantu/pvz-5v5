<!doctype html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="screen-orientation" content="landscape" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ»</text></svg>"
    />
    <title>æ¤ç‰©å¤§æˆ˜åƒµå°¸ - è”æœºå¯¹æˆ˜</title>
    <style>
      :root {
        --primary: #4caf50;
        --accent: #ffd700;
        --danger: #ff5252;
        --zombie-purple: #9c27b0;
        --brain-pink: #e91e63;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        background: linear-gradient(135deg, #0a1f0a, #1a3c1a);
        min-height: 100vh;
        color: white;
        user-select: none;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 8px;
      }

      .welcome-screen {
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.97), rgba(20, 40, 20, 0.97));
        z-index: 6000;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .welcome-content {
        text-align: center;
      }
      .welcome-title {
        font-size: 60px;
        font-weight: 900;
        margin-bottom: 10px;
        background: linear-gradient(180deg, #4caf50, #8bc34a);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
      }
      .welcome-subtitle {
        font-size: 18px;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 30px;
      }
      .name-input-large {
        padding: 16px 24px;
        font-size: 20px;
        border: 2px solid var(--accent);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        text-align: center;
        width: 280px;
        margin-bottom: 20px;
      }
      .name-input-large::placeholder {
        color: rgba(255, 255, 255, 0.4);
      }
      .enter-btn {
        padding: 16px 50px;
        font-size: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary), #388e3c);
        border: none;
        border-radius: 30px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
      }
      .enter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 30px rgba(76, 175, 80, 0.5);
      }

      .lobby {
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 40, 20, 0.95));
        z-index: 5000;
        display: none;
        padding: 20px 30px;
        overflow-y: auto;
      }
      .lobby-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
      }
      .lobby-title {
        font-size: 24px;
        font-weight: 700;
      }
      .user-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .user-badge:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .lobby-grid {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .section-title {
        font-size: 16px;
        margin-bottom: 12px;
        color: var(--accent);
      }

      .mode-grid {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .mode-btn {
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 700;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        color: white;
        cursor: pointer;
        transition: all 0.2s;
      }
      .mode-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .mode-btn.selected {
        border-color: var(--accent);
        background: rgba(255, 215, 0, 0.2);
      }
      .create-btn {
        width: 100%;
        padding: 14px;
        font-size: 16px;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary), #388e3c);
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
      }
      .create-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
      }

      .room-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .room-section .section-title {
        font-size: 14px;
        color: var(--accent);
        margin-bottom: 8px;
      }
      .room-list {
        max-height: 300px;
        overflow-y: auto;
      }
      .room-card {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.2s;
      }
      .room-card:hover {
        border-color: var(--accent);
        background: rgba(255, 255, 255, 0.12);
      }
      .room-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
      }
      .room-name {
        font-weight: 700;
        font-size: 14px;
      }
      .room-mode {
        background: var(--accent);
        color: #000;
        padding: 2px 8px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 700;
      }
      .room-players {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
      }
      .no-rooms {
        text-align: center;
        padding: 30px;
        color: rgba(255, 255, 255, 0.4);
        font-size: 14px;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 5500;
        display: none;
        justify-content: center;
        align-items: center;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal-box {
        background: linear-gradient(135deg, #1a2a1a, #0a150a);
        padding: 24px;
        border-radius: 16px;
        border: 2px solid var(--accent);
        text-align: center;
        min-width: 400px;
      }
      .modal-title {
        font-size: 20px;
        margin-bottom: 16px;
        color: var(--accent);
      }
      .team-grid {
        display: flex;
        gap: 6px;
        justify-content: center;
        margin-bottom: 10px;
      }
      .team-card {
        padding: 14px 22px;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
      }
      .team-card.plants {
        background: rgba(76, 175, 80, 0.2);
        border-color: #4caf50;
      }
      .team-card.zombies {
        background: rgba(156, 39, 176, 0.2);
        border-color: #9c27b0;
      }
      .team-card .icon {
        font-size: 28px;
      }
      .team-card .label {
        font-size: 12px;
        font-weight: 700;
      }
      .team-card .count {
        font-size: 9px;
        opacity: 0.7;
      }
      .modal-close {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 10px;
      }

      .waiting-room {
        display: none;
        margin-top: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .waiting-title {
        font-size: 18px;
        margin-bottom: 6px;
        text-align: center;
      }
      .waiting-slots {
        display: flex;
        gap: 14px;
        justify-content: center;
        margin-bottom: 10px;
      }
      .slot-column {
        background: rgba(0, 0, 0, 0.3);
        padding: 6px;
        border-radius: 6px;
        min-width: 120px;
      }
      .slot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
        font-size: 12px;
      }
      .slot-header.plants {
        color: #8bc34a;
      }
      .slot-header.zombies {
        color: #ce93d8;
      }
      .add-bot {
        cursor: pointer;
        font-size: 12px;
        opacity: 0.6;
      }
      .player-slot {
        padding: 4px 6px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 3px;
        margin-bottom: 2px;
        font-size: 9px;
      }
      .player-slot.empty {
        opacity: 0.4;
      }
      .player-slot.bot {
        background: rgba(255, 215, 0, 0.15);
      }
      .leave-btn {
        display: block;
        margin: 0 auto;
        background: rgba(255, 82, 82, 0.3);
        border: 1px solid #ff5252;
        padding: 5px 15px;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 10px;
      }

      #main-wrapper {
        display: none;
        flex-direction: row;
        gap: 8px;
      }

      #game-container {
        width: 990px;
        height: 610px;
        position: relative;
        border-radius: 10px;
        background: linear-gradient(180deg, #2d5a27, #1a3c16);
        border: 3px solid #2d1f0f;
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.6);
        overflow: hidden;
        flex-shrink: 0;
      }

      #top-bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 65px;
        padding: 3px 6px;
        display: flex;
        align-items: center;
        gap: 4px;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7));
        z-index: 100;
        border-bottom: 2px solid var(--accent);
      }

      .resource-box {
        display: flex;
        align-items: center;
        background: rgba(0, 0, 0, 0.6);
        padding: 3px 8px;
        border-radius: 20px;
        border: 2px solid;
        min-width: 68px;
      }
      .resource-box.sun {
        border-color: var(--accent);
      }
      .resource-box.brain {
        border-color: var(--brain-pink);
      }
      .resource-icon {
        font-size: 13px;
        margin-right: 2px;
      }
      .resource-count {
        font-size: 12px;
        font-weight: 800;
        min-width: 28px;
        text-align: right;
      }
      .resource-box.sun .resource-count {
        color: var(--accent);
      }
      .resource-box.brain .resource-count {
        color: #f48fb1;
      }

      #wave-display {
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 7px;
        border-radius: 4px;
        font-size: 10px;
        min-width: 38px;
        text-align: center;
      }
      #wave-display .wave-num {
        color: var(--accent);
        font-weight: 700;
        display: inline-block;
        min-width: 1.2em;
        text-align: center;
      }

      #player-info {
        display: flex;
        align-items: center;
        gap: 2px;
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
      }
      #player-info .team-icon {
        font-size: 13px;
      }
      #player-info .name {
        font-weight: 700;
        color: var(--accent);
        max-width: 45px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      #entity-menu {
        display: flex;
        gap: 2px;
        flex: 1;
        overflow-x: auto;
      }
      .entity-card {
        min-width: 42px;
        height: 52px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
      }
      .entity-card:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.2);
      }
      .entity-card.selected {
        border-color: var(--accent);
        background: rgba(255, 215, 0, 0.3);
        box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
      }
      .entity-card.disabled {
        filter: grayscale(100%) brightness(0.5);
        cursor: not-allowed;
      }
      .entity-card .icon {
        font-size: 17px;
      }
      .entity-card .cost {
        font-size: 7px;
        font-weight: 700;
        background: rgba(0, 0, 0, 0.6);
        padding: 1px 3px;
        border-radius: 3px;
      }
      .entity-card .name {
        font-size: 8px;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        white-space: nowrap;
      }
      .entity-card.plant-card .cost {
        color: var(--accent);
      }
      .entity-card.zombie-card {
        border-color: rgba(156, 39, 176, 0.5);
      }
      .entity-card.zombie-card.selected {
        border-color: var(--brain-pink);
        background: rgba(233, 30, 99, 0.3);
      }
      .entity-card.zombie-card .cost {
        color: #f48fb1;
      }
      .entity-card.shovel {
        border-color: #795548;
      }
      .entity-card.shovel.selected {
        border-color: #bcaaa4;
        background: rgba(121, 85, 72, 0.3);
      }

      #game-board {
        position: absolute;
        top: 65px;
        left: 0;
        width: 100%;
        height: calc(100% - 65px);
        z-index: 50;
      }
      #game-background {
        position: absolute;
        top: 65px;
        left: 0;
        width: 100%;
        height: calc(100% - 65px);
        background-image: linear-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
        background-size: 110px 109px;
        background-position: 0 0;
        z-index: 1;
        pointer-events: none;
      }

      .entity {
        position: absolute;
        pointer-events: none;
      }
      .plant {
        width: 70px;
        height: 70px;
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 38px;
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.4));
      }
      .zombie {
        width: 60px;
        height: 80px;
        z-index: 12;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 34px;
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.4));
        transition: left 0.05s linear;
      }
      .zombie.slowed {
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.4)) hue-rotate(180deg) brightness(1.2);
      }
      .zombie.hit {
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.4)) brightness(2) saturate(0);
      }

      .projectile {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        z-index: 15;
        pointer-events: none;
      }
      .pea-normal {
        background: radial-gradient(circle, #8bc34a, #4caf50);
        box-shadow: 0 0 3px #4caf50;
      }
      .pea-ice {
        background: radial-gradient(circle, #b3e5fc, #00bcd4);
        box-shadow: 0 0 4px #00bcd4;
      }

      .sun-token,
      .brain-token {
        position: absolute;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid white;
        z-index: 100;
        cursor: pointer;
        pointer-events: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        animation: float-token 2s ease-in-out infinite;
      }
      .sun-token {
        background: radial-gradient(circle, #fff9c4, #ffd700);
        box-shadow: 0 0 10px #ffd700;
      }
      .brain-token {
        background: radial-gradient(circle, #f8bbd9, #e91e63);
        box-shadow: 0 0 10px #e91e63;
      }
      @keyframes float-token {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
      }

      .health-bar {
        position: absolute;
        width: 38px;
        height: 3px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 1px;
        overflow: hidden;
        z-index: 20;
        pointer-events: none;
      }
      .health-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        transition: width 0.08s;
      }

      .cell-highlight {
        position: absolute;
        width: 110px;
        height: 109px;
        background: rgba(255, 255, 255, 0.06);
        border: 2px dashed rgba(255, 255, 255, 0.25);
        border-radius: 3px;
        pointer-events: none;
        z-index: 5;
        display: none;
      }
      .cell-highlight.remove {
        border-color: #ff5252;
        background: rgba(255, 82, 82, 0.1);
      }

      .floating-text {
        position: absolute;
        font-weight: 900;
        font-size: 11px;
        pointer-events: none;
        z-index: 200;
        text-shadow: 1px 1px 2px #000;
        animation: float-up 0.45s forwards;
      }
      @keyframes float-up {
        to {
          transform: translateY(-22px);
          opacity: 0;
        }
      }

      .explosion {
        position: absolute;
        font-size: 45px;
        z-index: 50;
        pointer-events: none;
        animation: explode 0.28s forwards;
      }
      @keyframes explode {
        0% {
          transform: scale(0.5);
          opacity: 1;
        }
        100% {
          transform: scale(1.3);
          opacity: 0;
        }
      }

      .wave-banner {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.85);
        padding: 12px 30px;
        border-radius: 8px;
        border: 2px solid var(--accent);
        font-size: 18px;
        font-weight: 900;
        z-index: 150;
        animation: wave-pop 1.5s forwards;
      }
      @keyframes wave-pop {
        0% {
          transform: translate(-50%, -50%) scale(0.5);
          opacity: 0;
        }
        10% {
          transform: translate(-50%, -50%) scale(1.1);
          opacity: 1;
        }
        20% {
          transform: translate(-50%, -50%) scale(1);
        }
        80% {
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(0.8);
          opacity: 0;
        }
      }

      .pause-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 200;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 10px;
      }
      .pause-overlay.active {
        display: flex;
      }
      .pause-title {
        font-size: 24px;
        color: var(--accent);
      }
      .pause-text {
        font-size: 12px;
        opacity: 0.7;
      }

      .row-selector {
        position: absolute;
        right: 10px;
        top: 65px;
        width: 50px;
        height: calc(100% - 65px);
        display: none;
        flex-direction: column;
        z-index: 60;
      }
      .row-selector.active {
        display: flex;
      }
      .row-btn {
        flex: 1;
        background: rgba(156, 39, 176, 0.3);
        border: 1px solid rgba(156, 39, 176, 0.5);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        color: white;
      }
      .row-btn:hover {
        background: rgba(233, 30, 99, 0.5);
      }

      .row-highlight {
        position: absolute;
        left: 0;
        width: 100%;
        height: 109px;
        background: rgba(233, 30, 99, 0.2);
        border: 2px dashed rgba(233, 30, 99, 0.6);
        pointer-events: none;
        z-index: 5;
        display: none;
      }

      .exit-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 82, 82, 0.3);
        border: 1px solid #ff5252;
        padding: 3px 8px;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 9px;
        z-index: 110;
      }

      .leaderboard {
        margin-top: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .leaderboard-title {
        font-size: 11px;
        color: var(--accent);
        margin-bottom: 4px;
      }
      .leaderboard-list {
        max-height: 120px;
        overflow-y: auto;
        font-size: 9px;
      }
      .lb-item {
        padding: 3px 4px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        justify-content: space-between;
      }
      .lb-winner {
        font-weight: 700;
      }
      .lb-winner.plants {
        color: #8bc34a;
      }
      .lb-winner.zombies {
        color: #ce93d8;
      }
      .lb-info {
        opacity: 0.6;
      }

      #side-panel {
        display: none; /* éšè—èŠå¤©å’Œæ—¥å¿— */
      }

      .side-box {
        background: rgba(0, 0, 0, 0.6);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
      }
      .side-box-header {
        padding: 8px 10px;
        background: rgba(255, 255, 255, 0.08);
        font-size: 12px;
        font-weight: 700;
        display: flex;
        justify-content: space-between;
        cursor: pointer;
      }
      .side-box-content {
        padding: 8px;
        font-size: 11px;
        max-height: 150px;
        overflow-y: auto;
      }
      .side-box-content.collapsed {
        display: none;
      }

      .log-entry {
        padding: 3px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        word-break: break-word;
      }
      .chat-msg {
        padding: 3px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        word-break: break-word;
      }
      .chat-msg .sender {
        color: var(--accent);
        font-weight: 700;
      }

      #chat-input {
        width: 100%;
        padding: 8px 10px;
        font-size: 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.4);
        color: white;
        margin-top: 5px;
      }
      #chat-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
      }

      .game-end-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 8000;
        display: none;
        justify-content: center;
        align-items: center;
      }
      .game-end-modal.active {
        display: flex;
      }
      .game-end-content {
        background: linear-gradient(135deg, #1a2a1a, #0a150a);
        padding: 22px 40px;
        border-radius: 12px;
        border: 2px solid var(--accent);
        text-align: center;
      }
      .game-end-title {
        font-size: 22px;
        margin-bottom: 6px;
      }
      .game-end-winner {
        font-size: 16px;
        color: var(--accent);
        margin-bottom: 12px;
      }
      .restart-btn {
        padding: 8px 25px;
        font-size: 13px;
        background: var(--primary);
        border: none;
        border-radius: 18px;
        color: white;
        cursor: pointer;
      }

      .lawnmower {
        position: absolute;
        width: 50px;
        height: 50px;
        font-size: 36px;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 15; /* Higher than plants to be visible */
        transition: left 3s linear;
        filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
      }

      .reconnecting-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9000;
        display: none;
        justify-content: center;
        align-items: center;
        font-size: 16px;
      }
      .reconnecting-overlay.active {
        display: flex;
      }

      /* ========== ç”Ÿäº§çº§ç§»åŠ¨ç«¯ä¼˜åŒ– ========== */

      /* æ¨ªå±æç¤ºè¦†ç›–å±‚ */
      .orientation-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, #0a1f0a 0%, #1a3c1a 100%);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 24px;
        text-align: center;
        padding: 20px;
      }
      .orientation-overlay .rotate-icon {
        font-size: 80px;
        animation: rotate-phone 2s ease-in-out infinite;
      }
      .orientation-overlay .rotate-text {
        font-size: 20px;
        font-weight: 700;
        color: var(--accent);
      }
      .orientation-overlay .rotate-hint {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.6);
        max-width: 280px;
      }
      @keyframes rotate-phone {
        0%,
        100% {
          transform: rotate(0deg);
        }
        25% {
          transform: rotate(-15deg);
        }
        75% {
          transform: rotate(15deg);
        }
      }

      /* ä»…åœ¨ç§»åŠ¨ç«¯ç«–å±æ—¶æ˜¾ç¤º */
      @media screen and (max-width: 1024px) and (orientation: portrait) {
        .orientation-overlay {
          display: flex !important;
        }
        #main-wrapper,
        .lobby,
        .welcome-screen {
          display: none !important;
        }
      }

      /* å…¨å±æŒ‰é’® */
      .fullscreen-btn {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 4px 10px;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-size: 14px;
        display: none;
        transition: all 0.2s;
      }
      .fullscreen-btn:hover,
      .fullscreen-btn:active {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.05);
      }

      /* ç§»åŠ¨ç«¯èŠå¤©/æ—¥å¿—åˆ‡æ¢æŒ‰é’® */
      .mobile-toggle-btn {
        display: none;
        position: fixed;
        bottom: env(safe-area-inset-bottom, 10px);
        right: env(safe-area-inset-right, 10px);
        background: rgba(0, 0, 0, 0.85);
        border: 2px solid var(--accent);
        padding: 10px 16px;
        border-radius: 30px;
        color: white;
        font-size: 16px;
        z-index: 200;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      /* ç§»åŠ¨ç«¯ä¾§è¾¹é¢æ¿è¦†ç›–å±‚ */
      .mobile-panel-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        z-index: 350;
      }
      .mobile-panel-overlay.active {
        display: block;
      }
      .mobile-panel-content {
        position: absolute;
        right: 0;
        top: 0;
        width: min(280px, 80vw);
        height: 100%;
        background: rgba(10, 30, 10, 0.98);
        padding: 15px;
        padding-right: env(safe-area-inset-right, 15px);
        overflow-y: auto;
        box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
      }
      .mobile-panel-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: var(--danger);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        color: white;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* ========== ç§»åŠ¨ç«¯æ¨ªå±ä¼˜åŒ– (è§¦å‘æ¡ä»¶ï¼šæ¨ªå± + é«˜åº¦ <= 500px) ========== */
      @media screen and (max-height: 500px) and (orientation: landscape) {
        body {
          padding: 0;
          margin: 0;
          overflow: hidden;
          align-items: center;
          justify-content: center;
          min-height: 100dvh;
          height: 100dvh;
        }

        /* æ¸¸æˆå®¹å™¨å®Œç¾é€‚é…å±å¹• */
        #main-wrapper {
          flex-direction: row;
          gap: 0;
          width: 100vw;
          height: 100dvh;
          justify-content: center;
          align-items: center;
          overflow: hidden;
        }

        #game-container {
          /* ä½¿ç”¨ JS åŠ¨æ€è®¡ç®— scaleï¼Œè¿™é‡Œè®¾ç½®å®¹å™¨æ ·å¼ */
          transform-origin: center center;
          border-radius: 0;
          border: none;
          box-shadow: none;
          /* å°†ç”± JS è®¾ç½® transform: scale() */
        }

        #side-panel {
          display: none;
        }

        .mobile-toggle-btn {
          display: none; /* æ‰‹æœºç«¯ä¸æ˜¾ç¤ºèŠå¤©/æ—¥å¿—æŒ‰é’® */
        }

        .fullscreen-btn {
          display: block;
        }

        /* éšè—è¿æ¥çŠ¶æ€ï¼ˆæ¸¸æˆä¸­ï¼‰ */
        .connection-status {
          display: none;
        }
      }

      /* ========== å¹³æ¿/å°æ¡Œé¢æ¨ªå± ========== */
      @media screen and (min-height: 501px) and (max-width: 1100px) and (orientation: landscape) {
        body {
          padding: 0;
          align-items: center;
          justify-content: center;
          min-height: 100dvh;
        }

        #main-wrapper {
          gap: 0;
        }

        #game-container {
          transform-origin: center center;
        }

        #side-panel {
          display: none;
        }

        .mobile-toggle-btn,
        .fullscreen-btn {
          display: block;
        }
      }

      /* ========== è§¦æ§ä¼˜åŒ–æ ·å¼ ========== */

      /* ç¦ç”¨ç§»åŠ¨ç«¯é»˜è®¤è¡Œä¸º */
      html,
      body {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior: none;
      }

      #game-container {
        touch-action: none;
      }

      #game-board {
        touch-action: none;
      }

      .entity-card,
      .sun-token,
      .brain-token,
      .row-btn {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }

      /* æ›´å¤§çš„è§¦æ§ç›®æ ‡ - ç§»åŠ¨ç«¯æ¨ªå± */
      @media screen and (max-height: 500px) and (orientation: landscape) {
        #top-bar {
          height: 50px;
          padding: 2px 6px;
          gap: 4px;
        }

        .resource-box {
          min-width: 60px;
          padding: 3px 8px;
        }
        .resource-icon {
          font-size: 12px;
        }
        .resource-count {
          font-size: 11px;
          font-weight: 800;
        }

        #wave-display {
          padding: 3px 8px;
          font-size: 10px;
        }

        #player-info {
          display: none;
        }

        /* å®ä½“å¡ç‰‡ - æ›´å¤§è§¦æ§åŒº */
        #entity-menu {
          gap: 4px;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none;
          -ms-overflow-style: none;
        }
        #entity-menu::-webkit-scrollbar {
          display: none;
        }

        .entity-card {
          min-width: 44px;
          height: 44px;
          padding: 2px;
        }
        .entity-card .icon {
          font-size: 18px;
        }
        .entity-card .cost {
          font-size: 8px;
          padding: 1px 3px;
        }
        .entity-card .name {
          display: none;
        }

        /* è§¦æ‘¸åé¦ˆå¢å¼º */
        .entity-card:active {
          transform: scale(0.95);
          opacity: 0.8;
        }
        .entity-card.selected {
          transform: scale(1.05);
        }

        /* è¡Œé€‰æ‹©å™¨ - æ›´å¤§è§¦æ§åŒº */
        .row-selector {
          width: 55px;
          right: 0;
          top: 50px;
          height: calc(100% - 50px);
        }
        .row-btn {
          font-size: 20px;
          font-weight: bold;
          border: 2px solid rgba(156, 39, 176, 0.8);
          background: rgba(156, 39, 176, 0.2);
        }
        .row-btn:active {
          background: rgba(233, 30, 99, 0.6);
          transform: scale(0.98);
        }

        /* æ¸¸æˆæ£‹ç›˜ä½ç½®è°ƒæ•´ */
        #game-board {
          top: 50px;
          height: calc(100% - 50px);
        }
        #game-background {
          top: 50px;
          height: calc(100% - 50px);
        }

        /* é˜³å…‰/è„‘å­ä»£å¸ - æ›´å¤§æ›´æ˜“ç‚¹å‡» */
        .sun-token,
        .brain-token {
          width: 36px;
          height: 36px;
          font-size: 16px;
        }
        .sun-token:active,
        .brain-token:active {
          transform: scale(1.2);
        }

        /* æŠ•é™æŒ‰é’® - å³ä¾§ */
        .exit-btn {
          padding: 6px 12px;
          font-size: 11px;
          top: 3px;
          right: 3px;
        }

        /* å…¨å±æŒ‰é’® - å·¦ä¾§ï¼Œé¿å…å’ŒæŠ•é™æŒ‰é’®é‡å  */
        .fullscreen-btn {
          position: absolute;
          top: 3px;
          left: 55px;
          right: auto;
        }

        /* æ¬¢è¿/å¤§å…é¡µé¢ - æ¨ªå±é€‚é… */
        .welcome-content {
          transform: scale(0.9);
        }
        .lobby {
          padding: 8px 16px;
        }
        .lobby-grid {
          grid-template-columns: 1fr 200px;
          gap: 8px;
          max-width: 100%;
        }

        /* æ¨¡æ€æ¡† */
        .modal-box {
          min-width: 260px;
          padding: 12px;
          max-height: 90dvh;
          overflow-y: auto;
        }
        .team-card {
          padding: 10px 16px;
        }
        .team-card .icon {
          font-size: 24px;
        }
      }

      /* ========== å®‰å…¨åŒºåŸŸé€‚é… (åˆ˜æµ·å±/åœ†è§’å±) ========== */
      @supports (padding: env(safe-area-inset-left)) {
        #top-bar {
          padding-left: max(6px, env(safe-area-inset-left));
          padding-right: max(6px, env(safe-area-inset-right));
        }
        #game-container {
          margin-left: env(safe-area-inset-left);
          margin-right: env(safe-area-inset-right);
        }
        .exit-btn {
          right: max(5px, env(safe-area-inset-right));
        }
      }
    </style>
  </head>
  <body>
    <div
      id="loading-overlay"
      style="position: fixed; inset: 0; background: #111; z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 24px"
    >
      ğŸŒ» åŠ è½½ä¸­...
    </div>

    <div class="reconnecting-overlay" id="reconnecting">ğŸ”„ é‡è¿ä¸­...</div>

    <!-- æ¨ªå±æç¤ºè¦†ç›–å±‚ -->
    <div class="orientation-overlay" id="orientation-overlay">
      <div class="rotate-icon">ğŸ“±</div>
      <div class="rotate-text">è¯·æ—‹è½¬æ‰‹æœºè‡³æ¨ªå±æ¨¡å¼</div>
      <div class="rotate-hint">ä¸ºè·å¾—æœ€ä½³æ¸¸æˆä½“éªŒï¼Œè¯·å°†æ‰‹æœºæ¨ªè¿‡æ¥</div>
    </div>

    <div id="welcome-screen" class="welcome-screen" style="display: none">
      <div class="welcome-content">
        <div class="welcome-title">ğŸŒ» æ¤ç‰©å¤§æˆ˜åƒµå°¸ ğŸ§Ÿ</div>
        <div class="welcome-subtitle">5v5 è”æœºå¯¹æˆ˜</div>
        <input type="text" id="name-input" class="name-input-large" placeholder="åå­—" maxlength="10" />
        <br />
        <button id="enter-btn" class="enter-btn">è¿›å…¥å¤§å…</button>
      </div>
    </div>

    <div id="lobby" class="lobby">
      <div class="lobby-header">
        <div class="lobby-title">ğŸ® å¤§å…</div>
        <div style="display: flex; align-items: center; gap: 8px">
          <div class="user-badge" style="cursor: pointer" onclick="editName()">
            âœï¸
            <span id="display-name">ç©å®¶</span>
          </div>
          <a
            href="https://github.com/hellojuantu/pvz-5v5"
            target="_blank"
            style="color: #fff; font-size: 16px; opacity: 0.7; text-decoration: none; display: flex"
            title="GitHub"
          >
            <svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
              />
            </svg>
          </a>
        </div>
      </div>
      <div class="lobby-grid">
        <div>
          <div class="section" id="create-section">
            <div class="section-title">â• åˆ›å»ºæˆ¿é—´</div>
            <div class="mode-grid">
              <button class="mode-btn" data-mode="1">1v1</button>
              <button class="mode-btn selected" data-mode="2">2v2</button>
              <button class="mode-btn" data-mode="3">3v3</button>
              <button class="mode-btn" data-mode="4">4v4</button>
              <button class="mode-btn" data-mode="5">5v5</button>
            </div>
            <div style="margin: 6px 0; font-size: 10px">
              æœ€å¤§æ³¢æ•°:
              <select id="max-waves" style="background: #222; color: white; border: 1px solid #555; padding: 2px">
                <option value="10">10æ³¢</option>
                <option value="15" selected>15æ³¢</option>
                <option value="20">20æ³¢</option>
                <option value="30">30æ³¢</option>
              </select>
            </div>
            <button id="create-btn" class="create-btn">åˆ›å»ºæˆ¿é—´</button>
          </div>
          <div id="waiting-room" class="waiting-room">
            <div class="waiting-title">â³ ç­‰å¾…</div>
            <div class="waiting-slots">
              <div class="slot-column">
                <div class="slot-header plants">
                  <span>ğŸŒ»</span>
                  <span class="add-bot" id="add-plant-bot">ğŸ¤–</span>
                </div>
                <div id="plant-slots"></div>
              </div>
              <div class="slot-column">
                <div class="slot-header zombies">
                  <span>ğŸ§Ÿ</span>
                  <span class="add-bot" id="add-zombie-bot">ğŸ¤–</span>
                </div>
                <div id="zombie-slots"></div>
              </div>
            </div>
            <button id="leave-btn" class="leave-btn">ç¦»å¼€</button>
          </div>
          <div class="leaderboard">
            <div class="leaderboard-title">ğŸ† æˆ˜ç»©æ¦œ</div>
            <div id="leaderboard-list" class="leaderboard-list"><div class="no-rooms">æ— è®°å½•</div></div>
          </div>
        </div>
        <div class="room-section">
          <div class="section-title">
            ğŸ“‹ æˆ¿é—´
            <span id="refresh-btn" style="cursor: pointer; opacity: 0.6">ğŸ”„</span>
          </div>
          <div id="room-list" class="room-list"><div class="no-rooms">åŠ è½½ä¸­</div></div>
        </div>
      </div>
    </div>

    <div id="team-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-title">é€‰æ‹©é˜µè¥</div>
        <div class="team-grid">
          <div class="team-card plants" id="select-plants">
            <span class="icon">ğŸŒ»</span>
            <span class="label">æ¤ç‰©</span>
            <span class="count" id="modal-plants-count">0/2</span>
          </div>
          <div class="team-card zombies" id="select-zombies">
            <span class="icon">ğŸ§Ÿ</span>
            <span class="label">åƒµå°¸</span>
            <span class="count" id="modal-zombies-count">0/2</span>
          </div>
        </div>
        <button class="modal-close" id="modal-close">å–æ¶ˆ</button>
      </div>
    </div>

    <div id="main-wrapper">
      <div id="game-container">
        <div id="game-background"></div>
        <div id="top-bar">
          <div class="resource-box sun" id="sun-box">
            <span class="resource-icon">â˜€ï¸</span>
            <span class="resource-count" id="sun-count">500</span>
          </div>
          <div class="resource-box brain" id="brain-box">
            <span class="resource-icon">ğŸ§ </span>
            <span class="resource-count" id="brain-count">500</span>
          </div>
          <div id="wave-display">
            æ³¢
            <span class="wave-num" id="wave-num">1</span>
            /
            <span id="max-waves-display">15</span>
          </div>
          <div id="player-info">
            <span class="team-icon" id="my-team-icon">ğŸŒ»</span>
            <span class="name" id="my-name-display">ç©å®¶</span>
          </div>
          <div id="entity-menu"></div>
        </div>
        <div id="game-board"></div>
        <div class="row-selector" id="row-selector"></div>
        <div class="pause-overlay" id="pause-overlay">
          <div class="pause-title">â¸ï¸ æ¸¸æˆæš‚åœ</div>
          <div class="pause-text">ç­‰å¾…ç©å®¶é‡è¿...</div>
        </div>
        <button class="exit-btn" id="exit-game-btn">ğŸ³ï¸ æŠ•é™</button>
      </div>
      <div id="side-panel">
        <div class="side-box">
          <div class="side-box-header" onclick="toggleBox('log')">
            <span>ğŸ“œ æ—¥å¿—</span>
            <span id="log-toggle">âˆ’</span>
          </div>
          <div class="side-box-content" id="action-log"></div>
        </div>
        <div class="side-box">
          <div class="side-box-header" onclick="toggleBox('chat')">
            <span>ğŸ’¬ èŠå¤©</span>
            <span id="chat-toggle">âˆ’</span>
          </div>
          <div class="side-box-content" id="chat-messages"></div>
          <div style="padding: 3px"><input type="text" id="chat-input" placeholder="Enterå‘é€" maxlength="80" /></div>
        </div>
      </div>
    </div>

    <!-- ç§»åŠ¨ç«¯é¢æ¿åˆ‡æ¢æŒ‰é’® -->
    <button class="mobile-toggle-btn" id="mobile-panel-btn">ğŸ’¬</button>

    <!-- ç§»åŠ¨ç«¯é¢æ¿è¦†ç›–å±‚ -->
    <div class="mobile-panel-overlay" id="mobile-panel">
      <div class="mobile-panel-content">
        <button class="mobile-panel-close" id="mobile-panel-close">Ã—</button>
        <div class="side-box" style="margin-top: 40px">
          <div class="side-box-header" onclick="toggleBox('log')">
            <span>ğŸ“œ æ—¥å¿—</span>
            <span id="log-toggle-mobile">âˆ’</span>
          </div>
          <div class="side-box-content" id="action-log-mobile"></div>
        </div>
        <div class="side-box" style="margin-top: 10px">
          <div class="side-box-header" onclick="toggleBox('chat')">
            <span>ğŸ’¬ èŠå¤©</span>
            <span id="chat-toggle-mobile">âˆ’</span>
          </div>
          <div class="side-box-content" id="chat-messages-mobile"></div>
          <div style="padding: 3px"><input type="text" id="chat-input-mobile" placeholder="Enterå‘é€" maxlength="80" /></div>
        </div>
      </div>
    </div>

    <div id="game-end-modal" class="game-end-modal">
      <div class="game-end-content">
        <div class="game-end-title">ğŸ® æ¸¸æˆç»“æŸ</div>
        <div class="game-end-winner" id="winner-text">æ¤ç‰©é˜Ÿèƒœåˆ©!</div>
        <button class="restart-btn" onclick="location.reload()">è¿”å›å¤§å…</button>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/game-mobile.js"></script>
    <script src="js/game-ui.js"></script>
    <script src="js/game-lobby.js"></script>
    <script src="js/game-core.js"></script>
    <script src="js/game-app.js"></script>
  </body>
</html>
